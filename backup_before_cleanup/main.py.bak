# main.py
import os
import sqlite3
from dotenv import load_dotenv
from pathlib import Path

# Cargar variables de entorno desde .env
load_dotenv()

# Verificar directamente si podemos acceder a la base de datos
db_path = os.environ.get('DB_PATH', 'app/data/app.db')
db_dir = Path(db_path).parent

print("=== Verificación de base de datos ===")
print(f"Ruta de la base de datos: {db_path}")
print(f"Directorio: {db_dir}")

# Asegurar que el directorio existe
try:
    os.makedirs(db_dir, exist_ok=True)
    print(f"✅ Directorio verificado/creado")
except Exception as e:
    print(f"❌ Error al crear directorio: {e}")

# Verificar permisos
try:
    with open(db_path, 'a'):
        pass
    print(f"✅ Archivo de base de datos accesible/creado")
except Exception as e:
    print(f"❌ Error al acceder al archivo de base de datos: {e}")

# Ahora importamos y creamos la aplicación
from app import create_app

app = create_app(os.getenv('FLASK_ENV', 'default'))

# Agregar ruta de diagnóstico
@app.route('/check_db')
def check_db():
    from flask import render_template_string
    import sqlite3
    
    try:
        # Intentar conectarse a la base de datos
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT name FROM sqlite_master WHERE type="table"')
        tables = cursor.fetchall()
        conn.close()
        
        tables_html = "\n".join([f"<li>{table[0]}</li>" for table in tables])
        
        return render_template_string("""
            <!DOCTYPE html>
            <html>
            <head>
                <title>Verificación de Base de Datos</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body class="bg-light">
                <div class="container py-5">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0">✅ Conexión a Base de Datos Exitosa</h4>
                        </div>
                        <div class="card-body">
                            <p class="lead">Se ha conectado correctamente a la base de datos SQLite.</p>
                            <p><strong>Ruta:</strong> {{ db_path }}</p>
                            
                            <h5 class="mt-4">Tablas disponibles:</h5>
                            <ul>
                                {{ tables_html|safe }}
                            </ul>
                            
                            <div class="mt-4">
                                <a href="/" class="btn btn-primary">Volver al Inicio</a>
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        """, db_path=db_path, tables_html=tables_html)
    except Exception as e:
        return render_template_string("""
            <!DOCTYPE html>
            <html>
            <head>
                <title>Error de Base de Datos</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body class="bg-light">
                <div class="container py-5">
                    <div class="card shadow">
                        <div class="card-header bg-danger text-white">
                            <h4 class="mb-0">❌ Error de Conexión a Base de Datos</h4>
                        </div>
                        <div class="card-body">
                            <p class="lead">No se ha podido conectar a la base de datos SQLite.</p>
                            <p><strong>Ruta:</strong> {{ db_path }}</p>
                            
                            <div class="alert alert-danger">
                                {{ error }}
                            </div>
                            
                            <h5 class="mt-4">Soluciones posibles:</h5>
                            <ol>
                                <li>Verifica que el directorio existe y tiene permisos de escritura.</li>
                                <li>Ejecuta <code>python reset_db.py</code> para recrear la base de datos desde cero.</li>
                                <li>Asegúrate de que la variable <code>DB_PATH</code> en el archivo <code>.env</code> es correcta.</li>
                            </ol>
                            
                            <div class="mt-4">
                                <a href="/" class="btn btn-primary">Volver al Inicio</a>
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        """, db_path=db_path, error=str(e))

if __name__ == '__main__':
    print("\n=== Iniciando aplicación AM3.1 ===")
    print(f"Configuración: {os.getenv('FLASK_ENV', 'default')}")
    print(f"Escuchando en: http://localhost:{os.getenv('PORT', 5000)}")
    app.run(host='0.0.0.0', port=int(os.getenv('PORT', 5000)))