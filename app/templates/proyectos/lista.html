{% extends "layout/base.html" %}
{% from 'layout/components.html' import action_buttons, confirmation_modal %}

{% block title %}AM3.1 - Proyectos{% endblock %}

{% block page_title %}Gestión de Proyectos{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <a href="{{ url_for('proyectos.nuevo_proyecto') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nuevo Proyecto
        </a>
    </div>
    <div class="col-md-4">
        <div class="input-group">
            <input type="text" class="form-control table-filter" placeholder="Buscar proyecto..." data-table="proyectos-table">
            <button class="btn btn-outline-secondary" type="button" onclick="exportTableToCSV('proyectos-table', 'proyectos.csv')">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="proyectos-table">
                <thead>
                    <tr>
                        <th>Referencia</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Nombre del Proyecto</th>
                        <th>Dirección</th>
                        <th>Fecha Creación</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proyecto in proyectos %}
                    <tr>
                        <td>
                            <span class="badge bg-info text-dark" data-bs-toggle="tooltip" title="PR: Prefijo | XXX: Cliente | TT: Tipo | DDMMAA: Fecha">
                                {{ proyecto.referencia }}
                            </span>
                        </td>
                        <td>{{ proyecto.cliente.nombre if proyecto.cliente else 'Sin cliente' }}</td>
                        <td>{{ proyecto.tipo_proyecto or 'No especificado' }}</td>
                        <td>{{ proyecto.nombre_proyecto or 'Sin nombre' }}</td>
                        <td>
                            {% if proyecto.nombre_via %}
                                {{ proyecto.nombre_via }}
                                {% if proyecto.numero %} {{ proyecto.numero }}{% endif %}
                                {% if proyecto.puerta %}, {{ proyecto.puerta }}{% endif %}
                                {% if proyecto.codigo_postal or proyecto.poblacion %},
                                    {{ proyecto.codigo_postal }} {{ proyecto.poblacion }}
                                {% endif %}
                            {% else %}
                                <em>No especificada</em>
                            {% endif %}
                        </td>
                        <td>{{ proyecto.fecha_creacion.strftime('%d/%m/%Y') if proyecto.fecha_creacion else 'No especificada' }}</td>
                        <td>
                            <span class="badge {% if proyecto.estado == 'Activo' %}bg-success{% elif proyecto.estado == 'Finalizado' %}bg-primary{% elif proyecto.estado == 'Cancelado' %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ proyecto.estado or 'No especificado' }}
                            </span>
                        </td>
                        <td>
                            {{ action_buttons(
                                edit_url=url_for('proyectos.editar_proyecto', id=proyecto.id),
                                delete_url=url_for('proyectos.eliminar_proyecto', id=proyecto.id),
                                confirm_id='delete-modal-' + proyecto.id|string,
                                custom_buttons=[
                                    {
                                        'url': '#',
                                        'class': 'btn-info ver-presupuestos-btn',
                                        'icon': 'fas fa-file-invoice-dollar',
                                        'title': 'Ver presupuestos',
                                        'data_attrs': {'proyecto-id': proyecto.id|string}
                                    },
                                    {
                                        'url': url_for('presupuestos.nuevo_presupuesto') + '?id_proyecto=' + proyecto.id|string,
                                        'class': 'btn-primary',
                                        'icon': 'fas fa-plus',
                                        'title': 'Crear presupuesto'
                                    }
                                ]
                            ) }}
                            
                            {{ confirmation_modal(
                                id='delete-modal-' + proyecto.id|string,
                                title='Confirmar eliminación',
                                message='¿Está seguro de que desea eliminar el proyecto "' + (proyecto.nombre_proyecto or proyecto.referencia) + '"? Esta acción no se puede deshacer.',
                                action_url=url_for('proyectos.eliminar_proyecto', id=proyecto.id)
                            ) }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No hay proyectos registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para ver presupuestos asociados -->
<div class="modal fade" id="presupuestosModal" tabindex="-1" aria-labelledby="presupuestosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="presupuestosModalLabel">Presupuestos asociados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Aquí se cargará el listado de presupuestos asociados vía AJAX -->
        <div id="presupuestosContent">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // Al hacer clic en los botones para ver presupuestos
  const verPresupuestosBtns = document.querySelectorAll(".ver-presupuestos-btn");
  verPresupuestosBtns.forEach(function(btn) {
    btn.addEventListener("click", function(e){
      e.preventDefault();
      const proyectoId = this.getAttribute("data-proyecto-id");
      // Se realiza la solicitud AJAX al endpoint que lista los presupuestos asociados
      fetch(`/presupuestos/por_proyecto/${proyectoId}?modal=true`)
        .then(response => response.text())
        .then(html => {
          document.getElementById("presupuestosContent").innerHTML = html;
          const presupuestosModal = new bootstrap.Modal(document.getElementById("presupuestosModal"));
          presupuestosModal.show();
        })
        .catch(err => {
          document.getElementById("presupuestosContent").innerHTML = "<div class='alert alert-danger'>Error al cargar presupuestos.</div>";
          console.error("Error al cargar presupuestos:", err);
        });
    });
  });
  
  // Inicializar los tooltips de Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
});
</script>
{% endblock %}